# GSOD & ISD Processing — Script Overview

This repository includes a mirrored set of scripts for GSOD and ISD so that figures and statistics remain comparable. Unless otherwise noted, each GSOD script has an ISD counterpart with identical behavior and CLI flags (only dataset names differ).

## 1) Index builders (with optional country tagging / filtering)

### `scripts/gsod_build_index.py`
- **Purpose:** Build a yearly station index for GSOD within a given bounding box (BBOX). Optionally attach ISO-like country codes to each station row and/or emit a China-only index.
- **Inputs:**
  - GSOD metadata (history/inventory as your pipeline defines)
  - Optional country shapefile or pre-mapped station→country table
- **Outputs:**
  - `data/gsod/index/years/{YYYY}/stations_{YYYY}.csv`
  - (Optional) `data/gsod/index/years_china/{YYYY}/stations_{YYYY}_china.csv`
- **Key flags:**
  - `--bbox lon_min lon_max lat_min lat_max`
  - `--emit-china-index`
  - `--country-table path/to/country_map.csv`
- **Notes:** Produces a stable, de-duplicated index per year; downstream plotting scripts assume this structure.

### `scripts/isd_build_index.py`
- **Same as above** but for ISD metadata (e.g., `isd-history.txt`, `isd-inventory.txt`). If inventory coverage is partial for older years, the indexer gracefully falls back to `isd-history.txt` for station presence and period-of-record.

---

## 2) Year-comparison maps (fixed set of “focus years”)

### `scripts/gsod_years_comparison.py`
- **Purpose:** Generate two comparative maps for a set of focus years (e.g., 1931, 1935, 1954, 1998):
  1) All stations within the outer-nest BBOX
  2) China-only subset (same layout, styling, legend, titles; only data mask differs)
- **Inputs:** Yearly indices from the index builder.
- **Outputs:**
  - `docs/figs/gsod_maps/maps_all/stations_{YYYY}.png`
  - `docs/figs/gsod_maps/maps_china/stations_{YYYY}_china.png`
- **Key flags:**
  - `--years 1931 1935 1954 1998`
  - `--bbox ...` (must match indexer for consistency)
  - `--china-only` (toggles subset figure)
- **Behavioral parity:** An equivalent script `isd_years_comparison.py` creates identical figures for ISD with only the dataset name changed.

### `scripts/isd_years_comparison.py`
- **Drop-in twin** of the GSOD version. Produces:
  - `docs/figs/isd_maps/maps_all/stations_{YYYY}.png`
  - `docs/figs/isd_maps/maps_china/stations_{YYYY}_china.png`

---

## 3) Yearly station-count bar charts

### `scripts/gsod_yearly_counts_bar.py`
- **Purpose:** For each year in `[start, end]`, count stations within the outer BBOX and split into two bars:
  - China vs. outside-China (but still inside the outer BBOX).
- **Outputs:** `docs/figs/gsod_counts/gsod_yearly_counts_{start}_{end}.png`
- **Key flags:**
  - `--start-year 1901 --end-year 2025`
  - `--bbox ...`
  - `--annotate-milestones 1931 1935 1954 1998` (optional arrow markers)
- **Notes:** Uses the same style and layout as the ISD counterpart.

### `scripts/isd_yearly_counts_bar.py`
- **Identical interface** and styling for ISD:
  - Output: `docs/figs/isd_counts/isd_yearly_counts_{start}_{end}.png`

---

## 4) Shared plotting utilities (if applicable)

### `scripts/lib/plot_utils.py`
- **Purpose:** Centralize consistent figure aesthetics (fonts, DPI, margins, legend placement) and shared helpers:
  - `make_axes_with_outer_bbox()`
  - `scatter_stations(ax, df, ...)`
  - `format_panel_title(year, n_stations)`
  - `annotate_milestone_years(ax, years)`
- **Benefit:** Guarantees GSOD/ISD paired figures are visually comparable.

---

## 5) Typical usage patterns

**Build/refresh indices**
```bash
# GSOD
python scripts/gsod_build_index.py --bbox 85.5 130.0 18.0 40.0 --emit-china-index

# ISD (falls back to isd-history.txt where inventory is incomplete)
python scripts/isd_build_index.py --bbox 85.5 130.0 18.0 40.0 --emit-china-index
```

**Make four-year comparison maps (both full BBOX and China-only)**
```bash
# GSOD
python scripts/gsod_years_comparison.py --years 1931 1935 1954 1998 --bbox 85.5 130.0 18.0 40.0 --china-only

# ISD
python scripts/isd_years_comparison.py --years 1931 1935 1954 1998 --bbox 85.5 130.0 18.0 40.0 --china-only
```

**Make yearly station-count bar charts (parallel GSOD/ISD)**
```bash
# GSOD
python scripts/gsod_yearly_counts_bar.py --start-year 1901 --end-year 2025 \
  --bbox 85.5 130.0 18.0 40.0 --annotate-milestones 1931 1935 1954 1998

# ISD
python scripts/isd_yearly_counts_bar.py --start-year 1901 --end-year 2025 \
  --bbox 85.5 130.0 18.0 40.0 --annotate-milestones 1931 1935 1954 1998
```

---

## 6) Reproducibility notes

- Keep the **same BBOX** for index-building and plotting; otherwise counts and maps will diverge.
- If `isd-inventory.txt` is partial for early decades, station presence is derived from `isd-history.txt` to keep year coverage consistent.
- China subset is derived either from a country join during indexing or a post-filter on an attached `country` column. Both GSOD/ISD paths use the same logic.
- All outputs are written under `docs/figs/...` to keep figures versioned and reviewable.
